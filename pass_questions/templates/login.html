<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passco - Neon Login</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define Neon Green Color and Glow Effects */
        :root {
            /* Neon Green (Bright Lime) */
            --color-primary: 50 255 100; 
            /* Deep Black/Dark Blue Background for contrast */
            --color-dark-bg: 5 5 15; 
            font-family: 'Inter', sans-serif;
        }

        body {
            /* Set a solid deep black background */
            background-color: rgb(var(--color-dark-bg)); 
            
            /* Maintain centering and full height: This centers the section */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            overflow: hidden;
            position: relative; 
            color: #fff; /* Default text color for the page */
        }
        
        /* Full-screen background image */
        .background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            /* Using the user's selected image URL */
            background-image: url('https://static.vecteezy.com/system/resources/previews/026/190/465/large_2x/abstract-hexagonal-technology-hitech-background-neon-green-black-free-photo.jpg'); 
            background-size: cover;
            background-position: center;
            filter: brightness(0.5) contrast(1.2); /* Darken and enhance colors */
        }
        
        /* Keyframe for subtle button pulse effect */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(var(--color-primary), 0.6), 0 0 5px rgba(var(--color-primary), 0.3); }
            50% { box-shadow: 0 0 15px rgba(var(--color-primary), 0.8), 0 0 8px rgba(var(--color-primary), 0.5); }
        }

        /* Utility class for neon buttons with glow */
        .btn-neon {
            background-color: rgb(var(--color-primary));
            color: rgb(var(--color-dark-bg)); 
            box-shadow: 0 0 15px rgba(var(--color-primary), 0.7); 
            transition: all 0.2s ease-in-out;
            animation: pulse-glow 3s infinite alternate; /* Subtle breathing animation */
        }
        .btn-neon:hover {
            box-shadow: 0 0 30px rgba(var(--color-primary), 1); 
            transform: translateY(-2px);
        }

        /* Utility class for neon text */
        .text-neon {
            color: rgb(var(--color-primary));
            text-shadow: 0 0 8px rgba(var(--color-primary), 0.8);
        }
        
        /* Custom focus style for inputs with neon glow border */
        .focus-neon:focus {
            outline: none;
            --tw-ring-opacity: 1;
            --tw-ring-color: rgb(var(--color-primary));
            border-color: rgb(var(--color-primary));
            box-shadow: 0 0 10px rgba(var(--color-primary), 0.6);
        }

        /* Inputs will now be directly over the background image, with dark transparent styling */
        .input-dark-transparent {
            background-color: rgba(0, 0, 0, 0.4); /* Darker transparent background */
            border: 1px solid rgba(50, 255, 100, 0.2); /* Subtle neon border */
            color: #fff;
            placeholder-color: rgba(255, 255, 255, 0.6);
        }
        .input-dark-transparent::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Style for the blurred section container itself */
        .blurred-login-section {
            position: relative; 
            z-index: 10; 
            width: 100%;
            max-width: 28rem; 
            padding: 2rem; 
            border-radius: 1rem; 
            
            /* Apply backdrop blur and a slight dark overlay to section */
            background-color: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            
            /* Optional: subtle border glow for the section itself */
            border: 1px solid rgba(50, 255, 100, 0.1);
        }
        
        /* Session notification style */
        .session-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid rgba(50, 255, 100, 0.3);
            border-radius: 50%;
            border-top: 4px solid rgb(50, 255, 100);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="background-image"></div>
    
    <div class="fixed inset-0 bg-repeat opacity-5 z-[1]" style="background-image: url('data:image/svg+xml;utf8,<svg width=\'10\' height=\'10\' viewBox=\'0 0 10 10\' xmlns=\'http://www.w3.org/2000/svg\'><rect width=\'1\' height=\'1\' fill=\'%230a0a0a\'/><rect x=\'5\' y=\'5\' width=\'1\' height=\'1\' fill=\'%230a0a0a\'/></svg>');"></div>
    
    <!-- Loading overlay (hidden by default) -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p id="loadingMessage">Logging in...</p>
    </div>
    
    <section class="flex flex-col items-center justify-center relative text-center px-6 overflow-hidden blurred-login-section">
        
        <h2 class="text-4xl font-bold text-gray-50 mb-2">Welcome Back</h2>
        <p class="text-gray-300 mb-10">
            Log in to your <span class="text-neon font-semibold">Passco</span> account
        </p>

        <form id="loginForm" class="space-y-5 w-full"> 
            <input type="email" id="email" placeholder="Email address" required
                class="w-full px-5 py-3 rounded-xl input-dark-transparent focus:outline-none focus:ring-2 focus-neon">

            <div class="relative">
                <input type="password" id="password" placeholder="Password" required
                    class="w-full px-5 py-3 pr-12 rounded-xl input-dark-transparent focus:outline-none focus:ring-2 focus-neon">
                <button type="button" onclick="window.togglePassword('password','togglePasswordIcon')"
                    class="absolute right-4 top-3.5 text-gray-400 hover:text-neon transition">
                    <svg id="togglePasswordIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M2.25 12s3.75-7.5 9.75-7.5S21.75 12 21.75 12 18 19.5 12 19.5 2.25 12 2.25 12z" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" />
                    </svg>
                </button>
            </div>

            <button type="submit"
                class="w-full py-3 font-semibold rounded-xl shadow-lg transition btn-neon">Login</button>
        </form>

        <div class="flex items-center my-8 w-full">
            <hr class="flex-grow border-gray-700">
            <span class="mx-3 text-gray-500 text-sm">Or</span>
            <hr class="flex-grow border-gray-700">
        </div>

        <button id="googleSignIn" type="button"
            class="w-full flex items-center justify-center gap-3 py-3 rounded-xl shadow-sm text-gray-50 hover:border-neon hover:text-neon transition input-dark-transparent">
            <!-- Updated Google Icon SVG -->
            <svg class="w-5 h-5" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.000,4.8c1.37,0,2.68,0.45,3.74,1.26l3.36-3.36C17.65,1.52,14.99,0,12.000,0C7.270,0,3.190,2.69,1.190,6.62L5.050,9.75C6.150,7.18,8.870,4.8,12.000,4.8z" fill="#EA4335"/>
                <path d="M1.19,6.62c-0.24,0.78-0.38,1.61-0.38,2.46c0,0.85,0.14,1.68,0.38,2.46l3.86,3.13C5.51,13.88,5.19,13,5.19,12.08C5.19,11.16,5.51,10.28,6.05,9.75L1.19,6.62z" fill="#FBBC04"/>
                <path d="M12.000,24c-2.91,0-5.55-0.97-7.40-2.67l3.86-3.13C9.07,19.98,10.46,20.4,12.000,20.4c3.27,0,6.01-1.68,7.57-4.14l3.77,2.95C20.81,22.1,16.64,24,12.000,24z" fill="#34A853"/>
                <path d="M22.5,12c0-0.78-0.08-1.54-0.21-2.28h-9.98v4.56h5.81c-0.3,1.56-1.28,2.87-2.73,3.75l3.77,2.95c2.19-2.02,3.47-4.99,3.47-8.98C23.63,14.99,23.6,12,22.5,12z" fill="#4285F4"/>
            </svg>
            <span class="font-medium">Login with Google</span>
        </button>

        <p class="text-gray-400 mt-8 text-sm">
            Don't have an account?
            <a href="/auth/signup" class="text-neon hover:text-green-400 font-medium transition">Sign up</a>
        </p>
        
        <!-- Session info display (hidden by default) -->
        <div id="sessionInfo" class="mt-4 text-xs text-gray-500 hidden">
            <div class="flex items-center justify-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span>Single device session enabled</span>
            </div>
        </div>
        
        <!-- Error message display -->
        <div id="errorMessage" class="mt-4 p-3 bg-red-900/50 border border-red-700 rounded-lg text-red-200 text-sm hidden"></div>
        
        <!-- Debug info (hidden by default) -->
        <div id="debugInfo" class="mt-4 p-3 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-400 text-xs hidden">
            <p>Debug Information</p>
            <div id="debugContent"></div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            setPersistence,
            browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";

        const firebaseConfig = {{ firebase_config | tojson }};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        // Set session persistence
        await setPersistence(auth, browserSessionPersistence);

        // Show/hide loading overlay
        function showLoading(message = 'Logging in...') {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingMessage').textContent = message;
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Toggle debug info
        function toggleDebug() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.classList.toggle('hidden');
        }
        
        function addDebugInfo(info) {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div class="mt-1">[${timestamp}] ${info}</div>`;
        }

        // Toggle password visibility
        function togglePassword(fieldId, iconId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(iconId);
            if (field.type === "password") {
                field.type = "text";
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.5 12c0 1.272.243 2.483.686 3.597M12 4.5c3.3 0 6.3 1.697 8.02 4.223M21 12c0 1.25-.22 2.447-.624 3.558M9.88 9.88l4.24 4.24M9.88 14.12l4.24-4.24"/>`;
            } else {
                field.type = "password";
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12s3.75-7.5 9.75-7.5S21.75 12 21.75 12 18 19.5 12 19.5 2.25 12 2.25 12z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z"/>`;
            }
        }

        // -------- EMAIL/PASSWORD LOGIN (UPDATED WITH TOKEN VERIFICATION) --------
        document.getElementById("loginForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();
            
            if (!email || !password) {
                showError("Please fill in both email and password.");
                return;
            }

            showLoading("Authenticating with Firebase...");
            addDebugInfo(`Attempting login for: ${email}`);

            try {
                // Step 1: Sign in with Firebase
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                addDebugInfo(`Firebase login successful for: ${user.email}`);
                addDebugInfo(`User UID: ${user.uid}`);

                // Check if email is verified
                if (!user.emailVerified) {
                    hideLoading();
                    showError("Please verify your email address before logging in.");
                    return;
                }

                // Step 2: Get Firebase ID Token
                addDebugInfo("Getting Firebase ID token...");
                const idToken = await user.getIdToken();
                addDebugInfo(`Token obtained: ${idToken.substring(0, 50)}...`);

                // Step 3: Send token to backend for verification
                addDebugInfo("Sending token to backend for verification...");
                const response = await fetch("/auth/login_complete", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({
                        idToken: idToken,  // Send the Firebase token
                        email: user.email,
                        username: user.displayName || "",
                        uid: user.uid  // Also send UID for backward compatibility
                    })
                });

                addDebugInfo(`Backend response status: ${response.status}`);
                
                // Try to parse response as JSON
                let data;
                try {
                    data = await response.json();
                    addDebugInfo(`Backend response: ${JSON.stringify(data)}`);
                } catch (jsonError) {
                    addDebugInfo(`JSON parse error: ${jsonError.message}`);
                    const text = await response.text();
                    addDebugInfo(`Raw response: ${text.substring(0, 200)}`);
                    throw new Error(`Invalid server response: ${text.substring(0, 100)}`);
                }

                if (data.status === "success") {
                    addDebugInfo("Login successful! Redirecting...");
                    
                    // Store session info if provided
                    if (data.session_id) {
                        localStorage.setItem('passquestion_user_session', JSON.stringify({
                            uid: user.uid,
                            email: user.email,
                            session_id: data.session_id,
                            login_time: new Date().toISOString()
                        }));
                        document.getElementById('sessionInfo').classList.remove('hidden');
                    }
                    
                    // Redirect to appropriate page
                    if (data.redirect) {
                        hideLoading();
                        window.location.href = data.redirect;
                    } else {
                        // Default redirect based on user role
                        hideLoading();
                        if (data.user?.role === "admin") {
                            window.location.href = "/auth/admin/dashboard";
                        } else {
                            window.location.href = "/auth/dashboard";
                        }
                    }
                } else {
                    hideLoading();
                    addDebugInfo(`Login failed: ${data.message || "Unknown error"}`);
                    showError(data.message || "Login failed. Please try again.");
                    
                    // Show debug info for troubleshooting
                    toggleDebug();
                }
            } catch (err) {
                hideLoading();
                addDebugInfo(`Login error: ${err.message}`);
                console.error("Login error:", err);
                
                // Specific error messages
                if (err.code === "auth/user-not-found" || err.code === "auth/wrong-password") {
                    showError("Invalid email or password.");
                } else if (err.code === "auth/too-many-requests") {
                    showError("Too many failed attempts. Please try again later.");
                } else if (err.code === "auth/network-request-failed") {
                    showError("Network error. Please check your internet connection.");
                } else {
                    showError(`Login error: ${err.message}`);
                }
                
                // Show debug info
                toggleDebug();
            }
        });

        // -------- GOOGLE LOGIN (UPDATED WITH TOKEN VERIFICATION) --------
        document.getElementById("googleSignIn").addEventListener("click", async () => {
            showLoading("Connecting to Google...");
            addDebugInfo("Starting Google login...");

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                addDebugInfo(`Google login successful: ${user.email}`);
                addDebugInfo(`Google UID: ${user.uid}`);

                // Get Firebase ID Token
                addDebugInfo("Getting Firebase ID token...");
                const idToken = await user.getIdToken();
                addDebugInfo(`Token obtained: ${idToken.substring(0, 50)}...`);

                // Send token to backend
                addDebugInfo("Sending token to backend for verification...");
                const response = await fetch("/auth/login_complete", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({
                        idToken: idToken,  // Send the Firebase token
                        email: user.email,
                        username: user.displayName || "",
                        uid: user.uid  // Also send UID for backward compatibility
                    })
                });

                addDebugInfo(`Backend response status: ${response.status}`);
                
                let data;
                try {
                    data = await response.json();
                    addDebugInfo(`Backend response: ${JSON.stringify(data)}`);
                } catch (jsonError) {
                    const text = await response.text();
                    addDebugInfo(`JSON parse error: ${jsonError.message}`);
                    addDebugInfo(`Raw response: ${text.substring(0, 200)}`);
                    throw new Error(`Invalid server response: ${text.substring(0, 100)}`);
                }

                if (data.status === "success") {
                    addDebugInfo("Google login successful! Redirecting...");
                    
                    // Store session info
                    if (data.session_id) {
                        localStorage.setItem('passquestion_user_session', JSON.stringify({
                            uid: user.uid,
                            email: user.email,
                            session_id: data.session_id,
                            login_time: new Date().toISOString()
                        }));
                        document.getElementById('sessionInfo').classList.remove('hidden');
                    }
                    
                    // Redirect
                    if (data.redirect) {
                        hideLoading();
                        window.location.href = data.redirect;
                    } else {
                        hideLoading();
                        if (data.user?.role === "admin") {
                            window.location.href = "/auth/admin/dashboard";
                        } else {
                            window.location.href = "/auth/dashboard";
                        }
                    }
                } else {
                    hideLoading();
                    addDebugInfo(`Google login failed: ${data.message}`);
                    showError(data.message || "Google login failed.");
                    toggleDebug();
                }
            } catch (err) {
                hideLoading();
                addDebugInfo(`Google login error: ${err.message}`);
                console.error("Google login error:", err);
                
                if (err.code === "auth/popup-closed-by-user") {
                    showError("Google login popup was closed. Please try again.");
                } else if (err.code === "auth/network-request-failed") {
                    showError("Network error. Please check your internet connection.");
                } else {
                    showError(`Google login error: ${err.message}`);
                }
                
                toggleDebug();
            }
        });

        // Check for existing session on page load
        document.addEventListener('DOMContentLoaded', function() {
            const existingSession = localStorage.getItem('passquestion_user_session');
            if (existingSession) {
                try {
                    const sessionData = JSON.parse(existingSession);
                    addDebugInfo(`Existing session found for: ${sessionData.email}`);
                    document.getElementById('sessionInfo').classList.remove('hidden');
                } catch (e) {
                    localStorage.removeItem('passquestion_user_session');
                }
            }
            
            // Auto-fill email if remembered
            const lastEmail = localStorage.getItem('last_login_email');
            if (lastEmail) {
                document.getElementById('email').value = lastEmail;
            }
        });

        // Save email on input change
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value.trim();
            if (email) {
                localStorage.setItem('last_login_email', email);
            }
        });

        // Make functions available globally
        window.togglePassword = togglePassword;
        window.showLoading = showLoading;
        window.hideLoading = hideLoading;
        window.showError = showError;
        window.toggleDebug = toggleDebug;
        window.addDebugInfo = addDebugInfo;
        
        // Test backend connection
        async function testBackendConnection() {
            try {
                addDebugInfo("Testing backend connection...");
                const response = await fetch('/auth/debug/firebase');
                const data = await response.json();
                addDebugInfo(`Backend test: ${data.status} - ${data.message}`);
                return data.status === 'success';
            } catch (error) {
                addDebugInfo(`Backend test failed: ${error.message}`);
                return false;
            }
        }
        
        // Run backend test on page load (optional)
        // testBackendConnection();
        
    </script>

    <script>
        // Session checking for logged-in pages
        if (window.location.pathname !== '/auth/login' && 
            window.location.pathname !== '/auth/signup' &&
            !window.location.pathname.includes('/static')) {
            
            // Check session periodically
            setInterval(async function() {
                const sessionData = localStorage.getItem('passquestion_user_session');
                if (!sessionData) return;
                
                try {
                    const response = await fetch('/auth/api/session/check');
                    const data = await response.json();
                    
                    if (!data.valid) {
                        localStorage.removeItem('passquestion_user_session');
                        
                        // Show notification
                        const notification = document.createElement('div');
                        notification.className = 'session-notification';
                        notification.innerHTML = `
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                </svg>
                                <span>${data.message || 'Session expired'}</span>
                            </div>
                        `;
                        
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            if (data.redirect) {
                                window.location.href = data.redirect;
                            } else {
                                window.location.href = '/auth/login';
                            }
                        }, 3000);
                    }
                } catch (error) {
                    console.error('Session check error:', error);
                }
            }, 120000); // Check every 2 minutes
        }
    </script>
</body>
</html>
